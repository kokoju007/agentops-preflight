# ACP Seller Runner

Agent-to-agent commerce layer for AgentOps Preflight, using the [Virtuals Protocol ACP SDK](https://www.npmjs.com/package/@virtuals-protocol/acp-node).

A **Seller agent** listens for incoming ACP jobs, calls the internal preflight endpoint, and delivers risk assessment results. A **Buyer agent** (test script) discovers the seller, initiates a job, and auto-evaluates the deliverable.

## Prerequisites

1. **Preflight server running** on `http://127.0.0.1:3000` (or your custom URL).
2. **INTERNAL_SECRET** — generated by the preflight server on startup if not set. Check the server log for:
   ```
   [server] INTERNAL_SECRET generated: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
   ```
3. **Virtuals Protocol ACP Portal** — both Seller and Buyer agents registered:
   - <https://app.virtuals.io/acp/join>
   - Create smart wallets and whitelist your developer wallets.
   - Configure at least one service offering for the Seller agent.

## Setup

```bash
cd acp-seller
npm install
```

Copy `.env.example` to `.env` and fill in values:

```bash
cp .env.example .env
```

### Environment Variables

| Variable | Description |
|---|---|
| `WHITELISTED_WALLET_PRIVATE_KEY` | Seller MetaMask private key (with `0x` prefix) |
| `SELLER_AGENT_WALLET_ADDRESS` | Seller agent smart wallet address from ACP Portal |
| `SELLER_ENTITY_ID` | Seller entity/session key ID from ACP Portal |
| `BUYER_WALLET_PRIVATE_KEY` | Buyer MetaMask private key (different wallet than Seller) |
| `BUYER_AGENT_WALLET_ADDRESS` | Buyer agent smart wallet address from ACP Portal |
| `BUYER_ENTITY_ID` | Buyer entity/session key ID from ACP Portal |
| `INTERNAL_SECRET` | Must match the preflight server's INTERNAL_SECRET |
| `PREFLIGHT_API_URL` | Default: `http://127.0.0.1:3000` |

## Running

### Step 1: Verify the internal endpoint

Before running the ACP flow, confirm the internal preflight endpoint works:

```bash
curl -X POST http://127.0.0.1:3000/internal/tx/preflight \
  -H "X-INTERNAL-SECRET: <your-secret>" \
  -H "Content-Type: application/json" \
  -d '{"transaction": "AQAAAA=="}'
```

A 200 response (even with `verdict: "fail"`) means the endpoint is working.
A 500 means you may need a real Solana transaction base64 sample.

### Step 2: Start the Seller

```bash
npx ts-node src/seller.ts
```

The seller will initialize and listen for incoming ACP jobs.

### Step 3: Run the Buyer test

In a separate terminal:

```bash
npx ts-node src/buyer-test.ts
```

### Expected flow

1. Buyer searches for the Seller via `browseAgents("preflight", ...)`.
2. If not found, falls back to direct `initiateJob` with `SELLER_AGENT_WALLET_ADDRESS`.
3. Seller receives job via `onNewTask` callback.
4. Seller accepts the job and extracts `tx_base64` from the memo.
5. Seller calls `POST /internal/tx/preflight` with the transaction.
6. Seller delivers the result back via ACP.
7. Buyer's `onEvaluate` callback auto-approves the deliverable.
8. Job completes and settles on-chain.

## Important Notes

- **Private keys**: `WHITELISTED_WALLET_PRIVATE_KEY` is the Seller MetaMask private key. `BUYER_WALLET_PRIVATE_KEY` is the Buyer MetaMask private key. These must be different wallets.
- **0x prefix**: Include the `0x` prefix in private keys. If you get a key parsing error, try removing it (npm docs and portal guides are inconsistent on this).
- **Never commit keys or secrets**. The `.env` file is gitignored.
- **Agent visibility**: In the ACP sandbox, agents need at least one job request to become visible in `browseAgents`. If the result is empty, the buyer falls back to direct `initiateJob`.
- **Double encoding**: The deliverable is double-encoded (`JSON.stringify({ result_json: JSON.stringify(result) })`). This is required by the SDK's string-typed `deliver()` method. The buyer's `onEvaluate` handles the parsing.
- **INTERNAL_SECRET must match**: The seller reads INTERNAL_SECRET from its own `.env`. This value must match the server's. If the server auto-generated it, copy the logged value.
